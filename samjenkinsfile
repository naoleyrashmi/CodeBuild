pipeline {
    agent any
    parameters {
                string(name: 'Account_Name', description: 'Please Enter the name of the customer.')
                string(name: 'Region', defaultValue: 'ua-east-2' , description: 'Please select the AWS Region')
                credentials(name: 'CREDENTIALS', description: 'AWS Credentials', credentialType: 'Username with password')       
                string(name: 'PrimePartition_Key', defaultValue: 'DataFlowId' , description: 'HashType PrimaryKey Name')
                string(name: 'PrimePartition_Key1', defaultValue: 'DataFlowId' , description: 'HashType PrimaryKey1 Name')
                string(name: 'PrimePartition_Key2', defaultValue: 'DataFlowId' , description: 'HashType PrimaryKey Name')
                string(name: 'PrimePartition_Key3', defaultValue: 'ConnectionId' , description: 'HashType PrimaryKey Name')
                booleanParam(name: 'APPLY_CHANGES', defaultValue: false, description: 'If not opted, it will be dry run')
            }
    stages {
            stage ('Setup Env') {
                    steps{
                        script {
                            currentBuild.displayName = "#${env.BUILD_NUMBER}-${env.ACCOUNT_NAME}-deployApp"
                            currentBuild.description = "${env.BUILD_NUMBER}-${env.ACCOUNT_NAME}-deployApp"
                        }
                    }
                } 
            stage("collect params") {
                    steps {
                    sh '''
                        #!/bin/bash
                        rm -rf params.yaml
                        export REGION=${Region}
                        export AccountName=${ACCOUNT_NAME}
                        export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID} 
                        export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
                        export PrimePartitionKey=${PrimePartition_Key}
                        export PrimePartitionKey1=${PrimePartition_Key1}
                        export PrimePartitionKey2=${PrimePartition_Key2}
                        export PrimePartitionKey3=${PrimePartition_Key3}
                        python generate_CF_params.py "REGION AccountName PrimePartitionKey PrimePartitionKey1 PrimePartitionKey2 PrimePartitionKey3" ${BUILD_ID}
                    '''
                }
            } 
            stage('Deploy Application') {
                    steps {
                        withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', accessKeyVariable: 'AWS_ACCESS_KEY_ID', credentialsId: CREDENTIALS, secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']]) {
                        withAWS(region: Region){
                            script{ 
                                   def s3Bucket
				   def outputs = samDeploy(
                                    stackName: "${Account_Name}-InitialSetup-app", 
                                    templateFile:'parentstack.yaml', 
                                    parameters: [[key: 'REGION', value: '$Region'], [key: 'AccountName', value: '$ACCOUNT_NAME'], [key: 'PrimePartitionKey', value: '$PrimePartition_Key'], [key: 'PrimePartitionKey1', value: '$PrimePartition_Key1'], [key: 'PrimePartitionKey2', value: '$PrimePartition_Key2'], [key: 'PrimePartitionKey3', value: '$PrimePartition_Key3']],
				    s3Bucket: "rashmi-ohio-sam-demo",
                                    region: "$Region"
                                )
                            echo "${outputs}"    
                        }
                    }
                }
            }
        }
    }
}       
