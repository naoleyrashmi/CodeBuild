pipeline {
    agent any
    parameters {
                string(name: 'AccountName', description: 'Please Enter the name of the customer.')
                string(name: 'Region', defaultValue: 'us-east-2' , description: 'Please select the AWS Region')
                credentials(name: 'CREDENTIALS', description: 'AWS Credentials', credentialType: 'Username with password')       
                string(name: 'PrimePartitionKey', defaultValue: 'DataFlowId' , description: 'HashType PrimaryKey Name')
                string(name: 'PrimePartitionKey1', defaultValue: 'DataFlowId' , description: 'HashType PrimaryKey1 Name')
                string(name: 'PrimePartitionKey2', defaultValue: 'DataFlowId' , description: 'HashType PrimaryKey Name')
                string(name: 'PrimePartitionKey3', defaultValue: 'ConnectionId' , description: 'HashType PrimaryKey Name')
                booleanParam(name: 'APPLY_CHANGES', defaultValue: false, description: 'If not opted, it will be dry run')
            }
    stages {
            stage ('Setup Env') {
                    steps{
                        script {
                            currentBuild.displayName = "#${env.BUILD_NUMBER}-${env.ACCOUNTNAME}-deployApp"
                            currentBuild.description = "${env.BUILD_NUMBER}-${env.ACCOUNTNAME}-deployApp"
                        }
                    }
                } 
            stage("collect params") {
                    steps {
                    sh '''
                        #!/bin/bash
                        rm -rf params.yaml
                        export REGION=${Region}
                        export AccountName=${ACCOUNTNAME}
                        export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID} 
                        export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
                        export PrimePartitionKey=${PrimePartitionKey}
                        export PrimePartitionKey1=${PrimePartitionKey1}
                        export PrimePartitionKey2=${PrimePartitionKey2}
                        export PrimePartitionKey3=${PrimePartitionKey3}
                        python generate_CF_params.py "REGION AccountName PrimePartitionKey PrimePartitionKey1 PrimePartitionKey2 PrimePartitionKey3" ${BUILD_ID}
                    '''
                }
            } 
            stage('Deploy Application') {
                    steps {
                            script{
				def outputs = samDeploy([credentialsId: CREDENTIALS,  parameters: [[key: 'REGION', value: "${Region}"], [key: 'AccountName', value: "${ACCOUNTNAME}"], [key: 'PrimePartitionKey', value: "${PrimePartitionKey}"], [key: 'PrimePartitionKey1', value: "${PrimePartitionKey1}"], [key: 'PrimePartitionKey2', value: "${PrimePartitionKey2}"], [key: 'PrimePartitionKey3', value: "${PrimePartitionKey3}"]], region: "${Region}", s3Bucket: "rashmi-ohio-sam-demo", stackName: "${AccountName}-InitialSetup-app", templateFile: 'parentstack.yaml']) 
                            echo "${outputs}"    
                        }
                    }
                }
            }
}       
